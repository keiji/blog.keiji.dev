<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
<title>Scrollerのススメ</title>

<meta name="description" content="Don&#39;t take your glasses off." />


  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62351683-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-62351683-1');
  </script>
  


<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="alternate" type="application/rss+xml" href="https://blog.keiji.dev/index.xml" title="めがねをかけるんだ">

<link id="dark-mode-theme" rel="stylesheet" href="https://blog.keiji.dev/css/dark.css" />
<link rel="stylesheet" href="https://blog.keiji.dev/fontawesome/css/all.min.css" />

<link rel="stylesheet" href="https://blog.keiji.dev/css/default.css" />


<script src="https://blog.keiji.dev/js/bundle.js"></script>
<script src="https://blog.keiji.dev/js/instantpage.js" type="module" defer></script>
<meta name="generator" content="Hugo 0.83.1" /><meta property="og:title" content="Scrollerのススメ" />
<meta property="og:description" content="
「みんなのコミック」は2018年10月31日を持ちまして更新を終了いたしました。
2020/11/09 追記:
みんコミAdvent Calendarその他の知見を元に、漫画表示用カスタムビュー「MangaView」を公開しました。

https://github.com/keiji/mangaview


はじめに
この記事は「みんコミ Advent Calendar」の18日目の記事です。
すみません。根雪れい（@neyuki_rei）さんの「おかあさん(10)と僕。」を読んでいたらアドベントカレンダーの更新が遅れてしまいました。

  
    10歳になったおかあさんと僕の生活をマンガにしましたよ～。見てくださいね ！　https://t.co/UfxCfaOYRZ　 #みんコミ #みんなのコミック pic.twitter.com/2nHBnFus4n
  
  
    — 根雪れい.おかあさん(10)と僕。連載中 (@neyuki_rei)
  
  
    2015, 11月 11
  

いやはや。まさかのお風呂回に驚きました。布団の柄とかが微妙に凝っていて細部を見ていくと楽しいです。
さて、アドベントカレンダー本編です。
「みんコミ」のAndroidアプリ（バージョン1.0.3）をベースに執筆しています。スクリーンショットは極力控える方針ですので、本記事を読む際には、「Google Play Store」からアプリをインストールしておくことをお勧めします。
（公開終了しています）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.keiji.dev/2015/12/mincomi-adventcalendar-18.html" /><meta property="og:image" content="https://blog.keiji.dev/images/logo.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-12-17T16:00:28&#43;00:00" />
<meta property="article:modified_time" content="2015-12-17T16:00:28&#43;00:00" />



<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.keiji.dev/images/logo.png"/>

<meta name="twitter:title" content="Scrollerのススメ"/>
<meta name="twitter:description" content="
「みんなのコミック」は2018年10月31日を持ちまして更新を終了いたしました。
2020/11/09 追記:
みんコミAdvent Calendarその他の知見を元に、漫画表示用カスタムビュー「MangaView」を公開しました。

https://github.com/keiji/mangaview


はじめに
この記事は「みんコミ Advent Calendar」の18日目の記事です。
すみません。根雪れい（@neyuki_rei）さんの「おかあさん(10)と僕。」を読んでいたらアドベントカレンダーの更新が遅れてしまいました。

  
    10歳になったおかあさんと僕の生活をマンガにしましたよ～。見てくださいね ！　https://t.co/UfxCfaOYRZ　 #みんコミ #みんなのコミック pic.twitter.com/2nHBnFus4n
  
  
    — 根雪れい.おかあさん(10)と僕。連載中 (@neyuki_rei)
  
  
    2015, 11月 11
  

いやはや。まさかのお風呂回に驚きました。布団の柄とかが微妙に凝っていて細部を見ていくと楽しいです。
さて、アドベントカレンダー本編です。
「みんコミ」のAndroidアプリ（バージョン1.0.3）をベースに執筆しています。スクリーンショットは極力控える方針ですので、本記事を読む際には、「Google Play Store」からアプリをインストールしておくことをお勧めします。
（公開終了しています）"/>

  </head>
  <body>
    
  




  <header>
    <nav class="navbar">
  <div class="nav">
    
      <a href="https://blog.keiji.dev/" class="nav-logo">
      <img src="https://blog.keiji.dev/images/logo.png"
           width=""
           height=""
           alt="Logo">
      </a>
    

    <ul class="nav-links">
      
        
          <li><a href="https://blog.keiji.dev/profile/" name="Profile"><i class="fas fa-user fa-lg"></i></a></li>
        
      
        
          <li><a href="https://blog.keiji.dev/licenses/" name="Licenses"><i class="fab fa-osi fa-lg"></i></a></li>
        
      
    </ul>
  </div>
</nav>

    <div class="intro-header">
      <div class="container">
        <div class="post-heading">
          
            <h1>Scrollerのススメ</h1>
          
          
            <span class="meta-post">
  <i class="fa fa-calendar-alt"></i>&nbsp;2015-12-17
  
    &nbsp;&nbsp;&nbsp;<i class="fa fa-folder-open"></i>&nbsp;
    
      <a href="https://blog.keiji.dev//categories/android/">Android</a>&nbsp;
    
      <a href="https://blog.keiji.dev//categories/%E3%81%BF%E3%82%93%E3%82%B3%E3%83%9F-advent-calendar/">みんコミ Advent Calendar</a>&nbsp;
    
  
</span>

          
        </div>
      </div>
    </div>
  </header>


    
  <div class="container" role="main">
    <article class="article" class="blog-post">
      
    <hr>
<p><strong><a href="https://twitter.com/mincomi_jp/status/1057847395889737730">「みんなのコミック」は2018年10月31日を持ちまして更新を終了いたしました。</a></strong></p>
<p>2020/11/09 追記:
みんコミAdvent Calendarその他の知見を元に、漫画表示用カスタムビュー「MangaView」を公開しました。</p>
<ul>
<li><a href="https://github.com/keiji/mangaview">https://github.com/keiji/mangaview</a></li>
</ul>
<hr>
<h2 id="はじめに">はじめに</h2>
<p>この記事は「<a href="http://qiita.com/advent-calendar/2015/mincomi">みんコミ Advent Calendar</a>」の18日目の記事です。</p>
<p>すみません。根雪れい（@neyuki_rei）さんの「おかあさん(10)と僕。」を読んでいたらアドベントカレンダーの更新が遅れてしまいました。</p>
<blockquote class="twitter-tweet" lang="ja">
  <p lang="ja" dir="ltr">
    10歳になったおかあさんと僕の生活をマンガにしましたよ～。見てくださいね ！　<a href="https://t.co/UfxCfaOYRZ">https://t.co/UfxCfaOYRZ</a>　 <a href="https://twitter.com/hashtag/%E3%81%BF%E3%82%93%E3%82%B3%E3%83%9F?src=hash">#みんコミ</a> <a href="https://twitter.com/hashtag/%E3%81%BF%E3%82%93%E3%81%AA%E3%81%AE%E3%82%B3%E3%83%9F%E3%83%83%E3%82%AF?src=hash">#みんなのコミック</a> <a href="https://t.co/2nHBnFus4n">pic.twitter.com/2nHBnFus4n</a>
  </p>
  <p>
    — 根雪れい.おかあさん(10)と僕。連載中 (@neyuki_rei)
  </p>
  <p>
    <a href="https://twitter.com/neyuki_rei/status/664369017038110720">2015, 11月 11</a>
  </p>
</blockquote>
<p>いやはや。まさかのお風呂回に驚きました。布団の柄とかが微妙に凝っていて細部を見ていくと楽しいです。</p>
<p>さて、アドベントカレンダー本編です。</p>
<p>「<a href="https://www.mincomi.jp">みんコミ</a>」のAndroidアプリ（バージョン1.0.3）をベースに執筆しています。スクリーンショットは極力控える方針ですので、本記事を読む際には、「Google Play Store」からアプリをインストールしておくことをお勧めします。</p>
<p><a href="https://play.google.com/store/apps/details?id=jp.ebookjapan.mincomi&amp;hl=ja"><img src="https://blog.keiji.dev/wp-content/uploads/2015/12/en_generic_rgb_wo_60.png" alt="en_generic_rgb_wo_60" width="172" height="60" class="aligncenter size-full wp-image-672" /></a>（公開終了しています）</p>
<hr>
<p>「みんコミ」アプリのコミックビューアー。</p>
<p>僕はたいていタブレット（Nexus 9、Xperia Z3 Tablet Compact）で読んでいます（Nexus 5Xは画面が小さいので……）。</p>
<p>しかし、今日（正確には昨日）Nexus 5Xで作品を読んでいて、拡大した状態で勢いよくフリックしてもスクロールが加速しないことに気づきました。</p>
<p>個人的にはぴゅんと表示が跳んで欲しいと思います。</p>
<p>この処理は<code>Scroller</code>を使うと比較的簡単に実装できます。</p>
<p>サンプルプロジェクトを<a href="https://github.com/keiji/adventcalendar_2015_mincomi">GitHub</a>に置いておきます。</p>
<p><a href="https://github.com/keiji/adventcalendar_2015_mincomi">https://github.com/keiji/adventcalendar_2015_mincomi</a></p>
<p>サンプル「スクロールサンプル(ScrollerActivity)」では、赤い■をフリックすると移動するようにプログラムしています。</p>
<p><a href="https://blog.keiji.dev/wp-content/uploads/2015/12/device-2015-12-18-004150.png"><img src="https://blog.keiji.dev/wp-content/uploads/2015/12/device-2015-12-18-004150.png" alt="device-2015-12-18-004150" width="50%" height="50%" class="aligncenter size-full wp-image-940" /></a></p>
<p>まず、GestureDetectorでflingジェスチャーを取得します。</p>
<p>使い方は簡単です。GestureDetectorのインスタンスにonTouchが受け取るMotionEventを渡すだけで、onTouchEventの状況から判定して所定のジェスチャーのコールバック（今回の場合はonFling）が呼びます</p>
<pre><code class="java">&lt;br />public class ScrollerView extends View {
    private static final String TAG = ScrollerView.class.getSimpleName();

    private static final int SIZE = 100;
    private static final Paint PAINT = new Paint();

    static {
        PAINT.setColor(Color.RED);
    }

    private Rect mRect;

    private final GestureDetectorCompat mGestureDetector;

    public ScrollerView(Context context) {
        super(context);

        mGestureDetector = new GestureDetectorCompat(context, mOnGestureListener);

        setFocusable(true);
    }

    GestureDetector.OnGestureListener mOnGestureListener = new GestureDetector.OnGestureListener() {
        @Override
        public boolean onDown(MotionEvent e) {
            return true;
        }

        @Override
        public void onShowPress(MotionEvent e) {

        }

        @Override
        public boolean onSingleTapUp(MotionEvent e) {
            return true;
        }

        @Override
        public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {
            return true;
        }

        @Override
        public void onLongPress(MotionEvent e) {

        }

        @Override
        public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {
            return true;
        }
    };

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        Log.d(TAG, "onTouchEvent " + event.getAction());

        boolean handled = mGestureDetector.onTouchEvent(event);
        if (handled) {
            return true;
        }

        return super.onTouchEvent(event);
    }

    @Override
    protected void onDraw(Canvas canvas) {
        super.onDraw(canvas);

        if (mRect == null) {
            mRect = new Rect(0, 0, SIZE, SIZE);
            int left = (canvas.getWidth() - SIZE) / 2;
            int top = (canvas.getHeight() - SIZE) / 2;
            mRect.offset(left, top);
        }

        canvas.drawRect(mRect, PAINT);
    }
}
</code></pre>
<p>サンプルでは、Compatibility Libraryに含まれているGestureDetectorCompatを使用しています。</p>
<p>簡単と言っても、OnGestureListenerの各メソッドの戻り値には気をつけて下さい。Android Studioで自動生成するとデフォルトで各メソッドは<code>false</code>を返しますが、そのままではACTION_DOWN以外のイベントを受け取れません（当然、ジェスチャも受け取れません）。</p>
<p>適宜<code>true</code>を返すようにしましょう。</p>
<p>つぎは<code>Scroller</code>です。</p>
<p>インスタンス化し、onFlingで受け取った各種の値をそのままflingメソッドに渡します。これで、flingが始まってからの時間に応じて自動的にスクロール量を計算してくれます。</p>
<p>なおGoogleは、OverScrollerを使用するように推奨しています。</p>
<pre><code class="java">&lt;br />public class ScrollerView extends View {
    private static final String TAG = ScrollerView.class.getSimpleName();

    private static final int SIZE = 100;
    private static final Paint PAINT = new Paint();

    static {
        PAINT.setColor(Color.RED);
    }

    private Rect mRect;

    private final OverScroller mScroller;
    private final GestureDetectorCompat mGestureDetector;

    public ScrollerView(Context context) {
        super(context);

        mScroller = new OverScroller(context);
        mGestureDetector = new GestureDetectorCompat(context, mOnGestureListener);

        setFocusable(true);
    }

    GestureDetector.OnGestureListener mOnGestureListener = new GestureDetector.OnGestureListener() {
        @Override
        public boolean onDown(MotionEvent e) {
            return true;
        }

        @Override
        public void onShowPress(MotionEvent e) {

        }

        @Override
        public boolean onSingleTapUp(MotionEvent e) {
            return true;
        }

        @Override
        public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {
            return true;
        }

        @Override
        public void onLongPress(MotionEvent e) {

        }

        @Override
        public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {

            mScroller.fling(mRect.centerX(), mRect.centerY(),
                    Math.round(velocityX), Math.round(velocityY),
                    0, getWidth() - SIZE, 0, getHeight() - SIZE,
                    SIZE / 2, SIZE / 2);

            ViewCompat.postInvalidateOnAnimation(ScrollerView.this);

            return true;
        }
    };

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        Log.d(TAG, "onTouchEvent " + event.getAction());

        boolean handled = mGestureDetector.onTouchEvent(event);
        if (handled) {
            return true;
        }

        return super.onTouchEvent(event);
    }

    @Override
    protected void onDraw(Canvas canvas) {
        super.onDraw(canvas);

        if (mRect == null) {
            mRect = new Rect(0, 0, SIZE, SIZE);
            int left = (canvas.getWidth() - SIZE) / 2;
            int top = (canvas.getHeight() - SIZE) / 2;
            mRect.offset(left, top);
        }

        canvas.drawRect(mRect, PAINT);
    }

    @Override
    public void computeScroll() {
        super.computeScroll();

        if (mScroller.computeScrollOffset()) {
            mRect.offsetTo(mScroller.getCurrX(), mScroller.getCurrY());

            ViewCompat.postInvalidateOnAnimation(this);
        }
    }
}
</code></pre>
<p><code>fling</code>から<code>ViewCompat.postInvalidateOnAnimation(this);</code>を実行すると<code>computeScroll()</code>が呼び出されます。</p>
<p><code>mScroller.computeScrollOffset()</code>でスクロールの状態を計算し、（flingが続いていれば）その結果を<code>Rect</code>の位置として設定しています（ここで得られる値は、Scrollerのflingメソッドに与えた値を基にした絶対座標です）。</p>
<p><code>mScroller.computeScrollOffset()</code>がtrueである限り<code>postInvalidateOnAnimation</code>と<code>computeScroll</code>の連鎖が続き、やがてScrollerが完了すると移動も止まります。</p>
<p>なお、OverScrollerはその名の通り、最後の値を設定すればオーバースクロールを有効にして、バウンスさせることができます。例では赤い■のサイズの半分の量だけオーバースクロールさせるように設定しています。</p>
<p>あらためて、実装例をGitHubに置いておきます。</p>
<p>サンプルプロジェクトを<a href="https://github.com/keiji/adventcalendar_2015_mincomi">GitHub</a>に置いておきます。</p>
<p><a href="https://github.com/keiji/adventcalendar_2015_mincomi">https://github.com/keiji/adventcalendar_2015_mincomi</a></p>
<h3 id="実装参照">実装参照</h3>
<ul>
<li><a href="http://developer.android.com/intl/ja/training/gestures/detector.html">http://developer.android.com/intl/ja/training/gestures/detector.html</a></li>
<li><a href="http://developer.android.com/intl/ja/training/gestures/scroll.html">http://developer.android.com/intl/ja/training/gestures/scroll.html</a></li>
</ul>
<hr>
<pre><code>「有山圭二」は「みんなのコミック」及び運営の「株式会社イーブックイニシアティブジャパン」とは一切関係がありません。
また、本アドベントカレンダーの内容はあくまで参加者個人の見解です。
「みんなのコミック」の評価を目的とするものではありませんので、ご了承下さい。
</code></pre>
<hr>
<p>それでは明日19日の担当は、この記事を書くに当たってGestureDetectorCompatの存在を知ったけど、Compat系のクラスには嫌な思い出しかないという「有山圭二」さんです。</p>
<p>よろしくお願いします。</p>


      
    </article>
    
    
      
      
</div>

    <footer>
  

  <div class="container">
    <p class="credits copyright">
      <a href="https://blog.keiji.dev/about"></a>
      &nbsp;&copy;
      2021
      
      &nbsp;/&nbsp;
      <a href="https://blog.keiji.dev/">めがねをかけるんだ</a>
      
      &nbsp;&ndash;&nbsp;
      <i class="fas fa-moon" id="dark-mode-toggle"></i>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
    </p>
  </div>
</footer>

  </body>
</html>
